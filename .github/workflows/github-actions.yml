name: Flox Installer Smoke Test

run-name: ${{ github.actor }} is testing Flox install.sh

on: [push]

jobs:
  install:
    name: Install on ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-24.04
            runs_on: ubuntu-24.04
            type: deb
          - name: ubuntu-22.04
            runs_on: ubuntu-22.04
            type: deb
          - name: ubuntu-24.04-arm
            runs_on: ubuntu-24.04-arm
            type: deb
          - name: ubuntu-22.04-arm
            runs_on: ubuntu-22.04-arm
            type: deb
          - name: macos-15-arm64
            runs_on: macos-15
            type: darwin
            arch: aarch64
          - name: macos-15-intel
            runs_on: macos-15-intel
            type: darwin
          - name: macos-14-arm64
            runs_on: macos-14
            type: darwin
            arch: aarch64
          - name: fedora-x86_64
            runs_on: ubuntu-latest
            type: rpm
            container: registry.fedoraproject.org/fedora:latest
          - name: fedora-arm
            runs_on: ubuntu-24.04-arm
            type: rpm
            container: registry.fedoraproject.org/fedora:latest
          - name: debian-12
            runs_on: ubuntu-latest
            type: deb-container
            container: debian:12
          - name: amazonlinux-2023
            runs_on: ubuntu-latest
            type: rpm-container
            container: amazonlinux:2023
          - name: rockylinux-9
            runs_on: ubuntu-latest
            type: rpm-container
            container: rockylinux:9
            
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v5

      - name: Run install.sh (stable) on Debian/macOS
        if: matrix.type == 'deb' || matrix.type == 'darwin'
        run: |
          bash install.sh

      - name: Run install.sh (Containerized DEB)
        if: matrix.type == 'deb-container'
        run: |
          docker run --rm -v "${{ github.workspace }}":/workspace -w /workspace ${{ matrix.container }} \
            /bin/bash -eux -c "if ! command -v curl &>/dev/null; then apt-get update && apt-get install -y curl; fi; bash install.sh && flox --version"

      - name: Run install.sh (Containerized RPM)
        if: matrix.type == 'rpm' || matrix.type == 'rpm-container'
        run: |
          # Use provided container or default to fedora for backward compatibility if matrix.container missing
          container_image="${{ matrix.container }}"
          [[ -z "$container_image" ]] && container_image="registry.fedoraproject.org/fedora:latest"
          docker run --rm -v "${{ github.workspace }}":/workspace -w /workspace $container_image \
            /bin/bash -eux -c "if ! command -v curl &>/dev/null; then if command -v dnf &>/dev/null; then dnf -y install curl; elif command -v yum &>/dev/null; then yum -y install curl; fi; fi; bash install.sh && flox --version"

      - name: Verify flox is available (host)
        if: matrix.type == 'deb' || matrix.type == 'darwin'
        run: |
          command -v flox
          flox --version

  nix:
    name: Install on Nix (${{ matrix.name }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: NixOS-x86_64
            runs_on: ubuntu-latest
            method: nixos-docker
          - name: NixOS-arm64
            runs_on: ubuntu-24.04-arm
            method: nixos-docker
          - name: Ubuntu-Generic-Nix
            runs_on: ubuntu-latest
            method: generic-nix
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Install Nix (for generic-nix)
        if: matrix.method == 'generic-nix'
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Run install.sh (NixOS Docker)
        if: matrix.method == 'nixos-docker'
        run: |
          docker run --rm -v "${{ github.workspace }}":/workspace -w /workspace \
            nixos/nix:latest \
            /bin/sh -c "bash ./install.sh && flox --version"

      - name: Run install.sh (Generic Nix)
        if: matrix.method == 'generic-nix'
        run: |
          bash ./install.sh
          flox --version

  macos-nix:
    name: Install on macOS with Determinate Nix (${{ matrix.runs_on }})
    strategy:
      fail-fast: false
      matrix:
        runs_on: [macos-26, macos-15, macos-14]
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Install Determinate Nix
        uses: DeterminateSystems/nix-installer-action@v14
      - name: Run install.sh
        run: |
          bash install.sh
      - name: Verify flox
        run: |
          flox --version
